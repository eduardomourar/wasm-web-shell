name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: read

    steps:
      - uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f # v3

      - name: Cache cargo
        uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
      - name: Set up rust toolchain
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af # tag=v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: clippy,rustfmt
      - name: Install cargo-component
        run: cargo install cargo-component --locked --force --git https://github.com/bytecodealliance/cargo-component --rev 075e5a99448403a0e9f3ef5e848102aa096e8f62
      - name: Install wasmtime
        run: cargo install wasmtime-cli --locked --force --features="component-model" --git https://github.com/bytecodealliance/wasmtime --rev 2ad057d735edc43f8ba89428d483f2b2430c1068
      - name: Build WASI project
        working-directory: packages/aws-cli
        run: cargo component build --release
      - name: Build
        run: cargo build
      - name: Check formatting
        run: cargo fmt --all
      - name: Run clippy action to produce annotations
        uses: actions-rs/clippy-check@b5b5f21f4797c02da247df37026fcd0a5024aa4d # tag=v1
        with:
          args: --all-targets --all-features --no-deps
          token: ${{ secrets.GITHUB_TOKEN }}
          use-cross: false

      - name: Test WASI project
        working-directory: packages/aws-cli
        run: |
          cargo check
          export CARGO_TARGET_WASM32_WASI_RUNNER="wasmtime --dir /tmp -C cache=no -D debug-info -D log-to-files -W component-model -S preview2 -S common -S http"
          export RUST_LOG="trace,cranelift_codegen=off,cranelift_wasm=off,wasmtime_cranelift=off"
          export RUST_TEST_NOCAPTURE=1
          RUST_BACKTRACE=1 WASMTIME_BACKTRACE_DETAILS=1 cargo component test
          cat wasmtime.dbg.main

  pr-success:
    needs:
      - build
    # if pr-success is skipped, GH branch protection will not consider it a failure, we need to check the result of each dependency ourself
    # see: https://brunoscheufler.com/blog/2022-04-09-the-required-github-status-check-that-wasnt
    if: always()
    steps:
      - if: needs.build.result == 'failure'
        run: echo "build job failed, setting the failure() bit" && exit 1
      - if: success()
        run: echo "all dependencies succeeded"
    runs-on: ubuntu-latest
